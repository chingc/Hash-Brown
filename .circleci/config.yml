---

python_versions:
  - &py37 3.7.2
  - &py36 3.6.8

set_python: &set_python
  parameters:
    lint:
      type: boolean
      default: false
      description: Set true to lint
    tag:
      type: string
      default: latest
      description: Docker tag for circleci/python
  docker:
    - image: circleci/python:<< parameters.tag >>
      environment:
        TZ: America/New_York

restore: &restore
  keys:
    - &pk python-<< parameters.tag >>-pip-cache-v1-{{ .Branch }}-{{ checksum "poetry.lock" }}
    - python-<< parameters.tag >>-pip-cache-v1-{{ .Branch }}
    - python-<< parameters.tag >>-pip-cache-v1

save: &save
  key: *pk
  paths:
    - ~/.cache/pypoetry/virtualenvs

version: 2.1

commands:

  poetry:
    steps:
      - run:
          name: Install poetry
          command: |
            curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python
            echo 'source ~/.poetry/env' >> ${BASH_ENV}

  dependencies:
    steps:
      - run:
          name: Install dependencies
          command: |
            poetry install

  lint:
    steps:
      - run:
          name: Pylint
          command: |
            poetry run pylint hb
          when: always
      - run:
          name: Mypy
          command: |
            echo "Skipping"
            # poetry run mypy hb
          when: always

  test:
    steps:
      - run:
          name: Pytest
          command: |
            poetry run coverage run -m pytest -v --durations=5 --junit-xml=test-results/pytest/results.xml
      - run:
          name: Coverage
          command: |
            poetry run coverage html --include="hb/*" --directory=test-results/coverage
            poetry run coverage report --include="hb/*"
      - run:
          name: Codecov
          command: |
            poetry run codecov

  artifacts:
    steps:
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: test-results

jobs:

  test:
    <<: *set_python
    steps:
      - checkout
      - restore_cache:
          <<: *restore
      - poetry
      - dependencies
      - test
      - when:
          condition: << parameters.lint >>
          steps:
            - lint
      - artifacts

  warm:
    <<: *set_python
    steps:
      - checkout
      - restore_cache:
          <<: *restore
      - poetry
      - dependencies
      - save_cache:
          <<: *save

workflows:

  version: 2

  commit:
    jobs:
      - test:
          name: Python 3.7
          tag: *py37
          lint: true
      - test:
          name: Python 3.6
          tag: *py36

  weekly:
    jobs:
      - test:
          name: Weekly 3.7
          tag: *py37
          lint: true
      - test:
          name: Weekly 3.6
          tag: *py36
    triggers:
      - schedule:
          cron: 0 23 * * 0
          filters:
            branches:
              only:
                - master

  warming:
    jobs:
      - warm:
          name: Cache 3.7
          tag: *py37
      - warm:
          name: Cache 3.6
          tag: *py36
    triggers:
      - schedule:
          cron: 0 22 * * 0
          filters:
            branches:
              only:
                - master
